<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>FAST-ER: learn_fast_tree.cc Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.3 -->
<div class="tabs">
  <ul>
    <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
    <li><a href="modules.html"><span>Modules</span></a></li>
    <li><a href="annotated.html"><span>Classes</span></a></li>
    <li class="current"><a href="files.html"><span>Files</span></a></li>
  </ul>
</div>
<h1>learn_fast_tree.cc</h1><a href="learn__fast__tree_8cc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"></span>
<a name="l00003"></a>00003 <span class="comment">    This file is part of the FAST-ER machine learning system.</span>
<a name="l00004"></a>00004 <span class="comment">    Copyright (C) 2008  Edward Rosten and Los Alamos National Laboratory</span>
<a name="l00005"></a>00005 <span class="comment"></span>
<a name="l00006"></a>00006 <span class="comment">    This program is free software; you can redistribute it and/or modify</span>
<a name="l00007"></a>00007 <span class="comment">    it under the terms of the GNU General Public License as published by</span>
<a name="l00008"></a>00008 <span class="comment">    the Free Software Foundation; either version 2 of the License, or</span>
<a name="l00009"></a>00009 <span class="comment">    (at your option) any later version.</span>
<a name="l00010"></a>00010 <span class="comment"></span>
<a name="l00011"></a>00011 <span class="comment">    This program is distributed in the hope that it will be useful,</span>
<a name="l00012"></a>00012 <span class="comment">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l00013"></a>00013 <span class="comment">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l00014"></a>00014 <span class="comment">    GNU General Public License for more details.</span>
<a name="l00015"></a>00015 <span class="comment"></span>
<a name="l00016"></a>00016 <span class="comment">    You should have received a copy of the GNU General Public License along</span>
<a name="l00017"></a>00017 <span class="comment">    with this program; if not, write to the Free Software Foundation, Inc.,</span>
<a name="l00018"></a>00018 <span class="comment">    51 Franklin Street, Fifth Floor, Boston, MA 02110-1301 USA.</span>
<a name="l00019"></a>00019 <span class="comment">*/</span><span class="comment"></span>
<a name="l00020"></a>00020 <span class="comment">/**</span>
<a name="l00021"></a>00021 <span class="comment">    \file learn_fast_tree.cc Main file for the \p learn_fast_tree executable.  </span>
<a name="l00022"></a>00022 <span class="comment"></span>
<a name="l00023"></a>00023 <span class="comment">    &lt;tt&gt; learn_fast_tree [--weight.&lt;/tt&gt;&lt;i&gt;x  weight&lt;/i&gt;&lt;tt&gt; ] ... &lt; &lt;/tt&gt; \e infile \p &gt; \e outfile</span>
<a name="l00024"></a>00024 <span class="comment">    </span>
<a name="l00025"></a>00025 <span class="comment">    \p learn_fast_tree used ID3 to learn a ternary decision tree for corner</span>
<a name="l00026"></a>00026 <span class="comment">    detection. The data is read from the standard input, and the tree is written</span>
<a name="l00027"></a>00027 <span class="comment">    to the standard output. This is designed to learn FAST feature detectors,</span>
<a name="l00028"></a>00028 <span class="comment">    and does not allow for the possibility ambbiguity in the input data.</span>
<a name="l00029"></a>00029 <span class="comment"></span>
<a name="l00030"></a>00030 <span class="comment">    \section lfInput Input data</span>
<a name="l00031"></a>00031 <span class="comment"></span>
<a name="l00032"></a>00032 <span class="comment">    The input data has the following format:</span>
<a name="l00033"></a>00033 <span class="comment"></span>
<a name="l00034"></a>00034 <span class="comment">\verbatim</span>
<a name="l00035"></a>00035 <span class="comment"></span>
<a name="l00036"></a>00036 <span class="comment">5</span>
<a name="l00037"></a>00037 <span class="comment">[-1 -1] [1 1] [3 4] [5 6] [-3 4]</span>
<a name="l00038"></a>00038 <span class="comment">bbbbb 1     0</span>
<a name="l00039"></a>00039 <span class="comment">bsdsb 1000  1</span>
<a name="l00040"></a>00040 <span class="comment">.</span>
<a name="l00041"></a>00041 <span class="comment">.</span>
<a name="l00042"></a>00042 <span class="comment">.</span>
<a name="l00043"></a>00043 <span class="comment">\endverbatim</span>
<a name="l00044"></a>00044 <span class="comment">    </span>
<a name="l00045"></a>00045 <span class="comment">    The first row is the number of features. The second row is the the list of</span>
<a name="l00046"></a>00046 <span class="comment">    offsets assosciated with each feature. This list has no effect on the</span>
<a name="l00047"></a>00047 <span class="comment">    learning of the tree, but it is passed through to the outpur for</span>
<a name="l00048"></a>00048 <span class="comment">    convinience.</span>
<a name="l00049"></a>00049 <span class="comment"></span>
<a name="l00050"></a>00050 <span class="comment">    The remaining rows contain the data. The first field is the ternary feature</span>
<a name="l00051"></a>00051 <span class="comment">    vector. The three characters "b", "d" and "s" are the correspond to</span>
<a name="l00052"></a>00052 <span class="comment">    brighter, darker and similar respectively, with the first feature being</span>
<a name="l00053"></a>00053 <span class="comment">    stored in the first character and so on.</span>
<a name="l00054"></a>00054 <span class="comment"></span>
<a name="l00055"></a>00055 <span class="comment">    The next field is the number of instances of the particular feature.</span>
<a name="l00056"></a>00056 <span class="comment">    The third field is the class, with 1 for corner, and 0 for background.</span>
<a name="l00057"></a>00057 <span class="comment"></span>
<a name="l00058"></a>00058 <span class="comment"></span>
<a name="l00059"></a>00059 <span class="comment"></span>
<a name="l00060"></a>00060 <span class="comment">\subsection f9Generate Generating input data</span>
<a name="l00061"></a>00061 <span class="comment">    </span>
<a name="l00062"></a>00062 <span class="comment">    Ideally, input data will be generated from some sample images. The </span>
<a name="l00063"></a>00063 <span class="comment">    program FIXME can be used to do this.</span>
<a name="l00064"></a>00064 <span class="comment"></span>
<a name="l00065"></a>00065 <span class="comment">    Additionally, a the program fast_N_features can be used to generate all </span>
<a name="l00066"></a>00066 <span class="comment">    possible feature combinations for FAST-N features. When run without</span>
<a name="l00067"></a>00067 <span class="comment">    arguments, it generates data for FAST-9 features, otherwise the argument can</span>
<a name="l00068"></a>00068 <span class="comment">    be used to specify N.</span>
<a name="l00069"></a>00069 <span class="comment"></span>
<a name="l00070"></a>00070 <span class="comment">\section lfGen Output data</span>
<a name="l00071"></a>00071 <span class="comment">    </span>
<a name="l00072"></a>00072 <span class="comment">    The program does not generate source code directly, rather it generates an</span>
<a name="l00073"></a>00073 <span class="comment">    easily parsabel representation of a decision tree which can be turned in to</span>
<a name="l00074"></a>00074 <span class="comment">    source code.</span>
<a name="l00075"></a>00075 <span class="comment"></span>
<a name="l00076"></a>00076 <span class="comment">    The structure of the tree is described in detail in ::print_tree.</span>
<a name="l00077"></a>00077 <span class="comment">    </span>
<a name="l00078"></a>00078 <span class="comment">*/</span>
<a name="l00079"></a>00079 <span class="comment"></span>
<a name="l00080"></a>00080 <span class="comment">///\cond never</span>
<a name="l00081"></a>00081 <span class="comment"></span><span class="preprocessor">#ifndef DOXYGEN_IGNORE</span>
<a name="l00082"></a>00082 <span class="preprocessor"></span><span class="preprocessor">#include &lt;iostream&gt;</span>
<a name="l00083"></a>00083 <span class="preprocessor">#include &lt;sstream&gt;</span>
<a name="l00084"></a>00084 <span class="preprocessor">#include &lt;cstdlib&gt;</span>
<a name="l00085"></a>00085 <span class="preprocessor">#include &lt;list&gt;</span>
<a name="l00086"></a>00086 <span class="preprocessor">#include &lt;map&gt;</span>
<a name="l00087"></a>00087 <span class="preprocessor">#include &lt;vector&gt;</span>
<a name="l00088"></a>00088 <span class="preprocessor">#include &lt;cassert&gt;</span>
<a name="l00089"></a>00089 <span class="preprocessor">#include &lt;bitset&gt;</span>
<a name="l00090"></a>00090 <span class="preprocessor">#include &lt;algorithm&gt;</span>
<a name="l00091"></a>00091 <span class="preprocessor">#include &lt;string&gt;</span>
<a name="l00092"></a>00092 <span class="preprocessor">#include &lt;tr1/memory&gt;</span>
<a name="l00093"></a>00093 
<a name="l00094"></a>00094 <span class="preprocessor">#include &lt;stdint.h&gt;</span>
<a name="l00095"></a>00095 
<a name="l00096"></a>00096 <span class="preprocessor">#include &lt;tag/tuple.h&gt;</span>
<a name="l00097"></a>00097 <span class="preprocessor">#include &lt;tag/printf.h&gt;</span>
<a name="l00098"></a>00098 <span class="preprocessor">#include &lt;tag/stdpp.h&gt;</span>
<a name="l00099"></a>00099 <span class="preprocessor">#include &lt;tag/fn.h&gt;</span>
<a name="l00100"></a>00100 
<a name="l00101"></a>00101 <span class="preprocessor">#include &lt;cvd/image_ref.h&gt;</span>
<a name="l00102"></a>00102 
<a name="l00103"></a>00103 <span class="preprocessor">#include &lt;gvars3/instances.h&gt;</span>
<a name="l00104"></a>00104 <span class="preprocessor">#endif</span>
<a name="l00105"></a>00105 <span class="preprocessor"></span>
<a name="l00106"></a>00106 <span class="keyword">using namespace </span>std;
<a name="l00107"></a>00107 <span class="keyword">using namespace </span>tr1;
<a name="l00108"></a>00108 <span class="keyword">using namespace </span>tag;
<a name="l00109"></a>00109 <span class="keyword">using namespace </span>CVD;
<a name="l00110"></a>00110 <span class="keyword">using namespace </span>GVars3;<span class="comment"></span>
<a name="l00111"></a>00111 <span class="comment">///\endcond </span>
<a name="l00112"></a>00112 <span class="comment"></span><span class="comment"></span>
<a name="l00113"></a>00113 <span class="comment">///Representations of ternary digits.</span>
<a name="l00114"></a><a class="code" href="learn__fast__tree_8cc.html#5475d259eeee26da1b2bcffcc581ebcd">00114</a> <span class="comment"></span><span class="keyword">enum</span> <a class="code" href="learn__fast__tree_8cc.html#5475d259eeee26da1b2bcffcc581ebcd" title="Representations of ternary digits.">Ternary</a>
<a name="l00115"></a>00115 {
<a name="l00116"></a><a class="code" href="learn__fast__tree_8cc.html#5475d259eeee26da1b2bcffcc581ebcd921c8fbda165a3c2613fe9e6d75102d0">00116</a>     <a class="code" href="learn__fast__tree_8cc.html#5475d259eeee26da1b2bcffcc581ebcd921c8fbda165a3c2613fe9e6d75102d0">Brighter</a>=<span class="charliteral">'b'</span>,
<a name="l00117"></a><a class="code" href="learn__fast__tree_8cc.html#5475d259eeee26da1b2bcffcc581ebcd419a3322847cb783c0050a64a1df8743">00117</a>     <a class="code" href="learn__fast__tree_8cc.html#5475d259eeee26da1b2bcffcc581ebcd419a3322847cb783c0050a64a1df8743">Darker</a>  =<span class="charliteral">'d'</span>,
<a name="l00118"></a><a class="code" href="learn__fast__tree_8cc.html#5475d259eeee26da1b2bcffcc581ebcdbf5e6bccdc838bc194a062b340d0d1fc">00118</a>     <a class="code" href="learn__fast__tree_8cc.html#5475d259eeee26da1b2bcffcc581ebcdbf5e6bccdc838bc194a062b340d0d1fc">Similar</a> =<span class="charliteral">'s'</span>
<a name="l00119"></a>00119 };
<a name="l00120"></a>00120 <span class="comment"></span>
<a name="l00121"></a>00121 <span class="comment">///Print an error message and the exit</span>
<a name="l00122"></a>00122 <span class="comment">///@param E Error code</span>
<a name="l00123"></a>00123 <span class="comment">///@param S Format string</span>
<a name="l00124"></a>00124 <span class="comment">///@ingroup gUtility</span>
<a name="l00125"></a><a class="code" href="group__gUtility.html#g9a3d9e758aa01b90e2067121300f17d2">00125</a> <span class="comment"></span><span class="preprocessor">#define fatal(E, S, ...) vfatal((E), (S), (tag::Fmt,## __VA_ARGS__))</span><span class="comment"></span>
<a name="l00126"></a>00126 <span class="comment">///Print an error message and the exit, using Tuple stype VARARGS</span>
<a name="l00127"></a>00127 <span class="comment">///@param err Error code</span>
<a name="l00128"></a>00128 <span class="comment">///@param s Format string</span>
<a name="l00129"></a>00129 <span class="comment">///@param list Argument list</span>
<a name="l00130"></a>00130 <span class="comment">///@ingroup gUtility</span>
<a name="l00131"></a><a class="code" href="group__gUtility.html#g4a38fb954301d16e2b9da85d1ffc1543">00131</a> <span class="comment"></span>template&lt;class C&gt; void vfatal(int err, const string&amp; s, const C&amp; list)
<a name="l00132"></a>00132 {
<a name="l00133"></a>00133     vfPrintf(cerr, s + <span class="stringliteral">"\n"</span>, list);
<a name="l00134"></a>00134     exit(err);
<a name="l00135"></a>00135 }
<a name="l00136"></a>00136 <span class="comment"></span>
<a name="l00137"></a>00137 <span class="comment">/**This structure represents a datapoint. A datapoint is a group of pixels with</span>
<a name="l00138"></a>00138 <span class="comment">ternary values (much brighter than the centre, much darker than the centre or</span>
<a name="l00139"></a>00139 <span class="comment">similar to the centre pixel). In addition to the feature descriptor, the class</span>
<a name="l00140"></a>00140 <span class="comment">and number of instances is also stored.</span>
<a name="l00141"></a>00141 <span class="comment"></span>
<a name="l00142"></a>00142 <span class="comment">The maximum feature vector size is determined by the template parameter. This</span>
<a name="l00143"></a>00143 <span class="comment">allows the ternary vector to be stored in a bitset. This keeps the struct a</span>
<a name="l00144"></a>00144 <span class="comment">fixed size and removes the need for dynamic allocation.</span>
<a name="l00145"></a>00145 <span class="comment">*/</span>
<a name="l00146"></a><a class="code" href="structdatapoint.html">00146</a> <span class="keyword">template</span>&lt;<span class="keywordtype">int</span> FEATURE_SIZE&gt; <span class="keyword">struct </span><a class="code" href="structdatapoint.html" title="This structure represents a datapoint.">datapoint</a>
<a name="l00147"></a>00147 {<span class="comment"></span>
<a name="l00148"></a>00148 <span class="comment">    ///Construct a datapoint </span>
<a name="l00149"></a>00149 <span class="comment">    ///@param s The feature vector in string form </span>
<a name="l00150"></a>00150 <span class="comment">    ///@param c The number of instances</span>
<a name="l00151"></a>00151 <span class="comment">    ///@param is The class</span>
<a name="l00152"></a><a class="code" href="structdatapoint.html#fafa67b33690aa6773f0691587e1afb5">00152</a> <span class="comment"></span>    <a class="code" href="structdatapoint.html#02addd3776d39977e8bc238dd9774d43" title="Default constructor allows for storage in a std::vector.">datapoint</a>(<span class="keyword">const</span> <span class="keywordtype">string</span>&amp; s, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> c, <span class="keywordtype">bool</span> is)
<a name="l00153"></a>00153     :<a class="code" href="structdatapoint.html#f9e40282924df8dd715f8991b37db452" title="Number of instances.">count</a>(c),<a class="code" href="structdatapoint.html#d7c950354a9c8b1ba19204fdd6d2d6e5" title="Class.">is_a_corner</a>(is)
<a name="l00154"></a>00154     {
<a name="l00155"></a>00155         <a class="code" href="structdatapoint.html#020ec35c899ccbceb21c67ccde510b7c" title="This code reads a stringified representation of the feature vector and converts it...">pack_trits</a>(s);
<a name="l00156"></a>00156     }
<a name="l00157"></a>00157     <span class="comment"></span>
<a name="l00158"></a>00158 <span class="comment">    ///Default constructor allows for storage in a</span>
<a name="l00159"></a>00159 <span class="comment">    ///std::vector.</span>
<a name="l00160"></a><a class="code" href="structdatapoint.html#02addd3776d39977e8bc238dd9774d43">00160</a> <span class="comment"></span>    <a class="code" href="structdatapoint.html#02addd3776d39977e8bc238dd9774d43" title="Default constructor allows for storage in a std::vector.">datapoint</a>()
<a name="l00161"></a>00161     {}
<a name="l00162"></a>00162 
<a name="l00163"></a><a class="code" href="structdatapoint.html#f9e40282924df8dd715f8991b37db452">00163</a>     <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="structdatapoint.html#f9e40282924df8dd715f8991b37db452" title="Number of instances.">count</a>; <span class="comment">///&lt; Number of instances</span>
<a name="l00164"></a><a class="code" href="structdatapoint.html#d7c950354a9c8b1ba19204fdd6d2d6e5">00164</a> <span class="comment"></span>    <span class="keywordtype">bool</span> <a class="code" href="structdatapoint.html#d7c950354a9c8b1ba19204fdd6d2d6e5" title="Class.">is_a_corner</a>;   <span class="comment">///&lt; Class</span>
<a name="l00165"></a>00165 <span class="comment"></span>
<a name="l00166"></a><a class="code" href="structdatapoint.html#8c13f00e5ac2cb38b86b6185d0357457">00166</a>     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structdatapoint.html#8c13f00e5ac2cb38b86b6185d0357457" title="Maximum number of features representable.">max_size</a> = FEATURE_SIZE; <span class="comment">///&lt; Maximum number of features representable.</span>
<a name="l00167"></a>00167 <span class="comment"></span>    
<a name="l00168"></a>00168 <span class="comment"></span>
<a name="l00169"></a>00169 <span class="comment">    ///Extract a trit (ternary bit) from the feture vector.</span>
<a name="l00170"></a>00170 <span class="comment">    ///@param tnum Number of the bit to extract</span>
<a name="l00171"></a>00171 <span class="comment">    ///@return  The trit.</span>
<a name="l00172"></a><a class="code" href="structdatapoint.html#b0027b60bd2e9a137520442010c2caf8">00172</a> <span class="comment"></span>    <a class="code" href="learn__fast__tree_8cc.html#5475d259eeee26da1b2bcffcc581ebcd" title="Representations of ternary digits.">Ternary</a> <a class="code" href="structdatapoint.html#b0027b60bd2e9a137520442010c2caf8" title="Extract a trit (ternary bit) from the feture vector.">get_trit</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> tnum)<span class="keyword"> const</span>
<a name="l00173"></a>00173 <span class="keyword">    </span>{
<a name="l00174"></a>00174         assert(tnum &lt; size);
<a name="l00175"></a>00175         <span class="keywordflow">if</span>(<a class="code" href="structdatapoint.html#9d664f9582856d6f8f4d0e707a37e584" title="Used to store the ternary vector Ternary bits are stored using 3 out of the 4 values...">tests</a>[tnum] == 1)
<a name="l00176"></a>00176             <span class="keywordflow">return</span> <a class="code" href="learn__fast__tree_8cc.html#5475d259eeee26da1b2bcffcc581ebcd921c8fbda165a3c2613fe9e6d75102d0">Brighter</a>;
<a name="l00177"></a>00177         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="structdatapoint.html#9d664f9582856d6f8f4d0e707a37e584" title="Used to store the ternary vector Ternary bits are stored using 3 out of the 4 values...">tests</a>[tnum + <a class="code" href="structdatapoint.html#8c13f00e5ac2cb38b86b6185d0357457" title="Maximum number of features representable.">max_size</a>] == 1)
<a name="l00178"></a>00178             <span class="keywordflow">return</span> <a class="code" href="learn__fast__tree_8cc.html#5475d259eeee26da1b2bcffcc581ebcd419a3322847cb783c0050a64a1df8743">Darker</a>;
<a name="l00179"></a>00179         <span class="keywordflow">else</span>
<a name="l00180"></a>00180             <span class="keywordflow">return</span> <a class="code" href="learn__fast__tree_8cc.html#5475d259eeee26da1b2bcffcc581ebcdbf5e6bccdc838bc194a062b340d0d1fc">Similar</a>;
<a name="l00181"></a>00181     }
<a name="l00182"></a>00182 
<a name="l00183"></a>00183     <span class="keyword">private</span>:
<a name="l00184"></a>00184 
<a name="l00185"></a><a class="code" href="structdatapoint.html#9d664f9582856d6f8f4d0e707a37e584">00185</a>         bitset&lt;max_size*2&gt; <a class="code" href="structdatapoint.html#9d664f9582856d6f8f4d0e707a37e584" title="Used to store the ternary vector Ternary bits are stored using 3 out of the 4 values...">tests</a>; <span class="comment">///&lt;Used to store the ternary vector</span>
<a name="l00186"></a>00186 <span class="comment"></span><span class="comment">                                  ///Ternary bits are stored using 3 out of the</span>
<a name="l00187"></a>00187 <span class="comment"></span><span class="comment">                                  ///4 values storable by two bits.</span>
<a name="l00188"></a>00188 <span class="comment"></span><span class="comment">                                  ///Trit \e n is stored using the bits \e n and</span>
<a name="l00189"></a>00189 <span class="comment"></span><span class="comment">                                  ///\e n + \e max_size, with bit \e n being the</span>
<a name="l00190"></a>00190 <span class="comment"></span><span class="comment">                                  ///most significant bit.</span>
<a name="l00191"></a>00191 <span class="comment"></span><span class="comment">                                  ///</span>
<a name="l00192"></a>00192 <span class="comment"></span><span class="comment">                                  ///The values are</span>
<a name="l00193"></a>00193 <span class="comment"></span><span class="comment">                                  ///- 3 unused</span>
<a name="l00194"></a>00194 <span class="comment"></span><span class="comment">                                  ///- 2 Brighter</span>
<a name="l00195"></a>00195 <span class="comment"></span><span class="comment">                                  ///- 1 Darker</span>
<a name="l00196"></a>00196 <span class="comment"></span><span class="comment">                                  ///- 0 Similar</span>
<a name="l00197"></a>00197 <span class="comment"></span><span class="comment"></span>
<a name="l00198"></a>00198 <span class="comment">        ///This code reads a stringified representation of the feature vector</span>
<a name="l00199"></a>00199 <span class="comment">        ///and converts it in to the internal representation. </span>
<a name="l00200"></a>00200 <span class="comment">        ///The string represents one feature per character, using "b", "d" and</span>
<a name="l00201"></a>00201 <span class="comment">        ///"s".</span>
<a name="l00202"></a>00202 <span class="comment">        ///@param unpacked String to parse.</span>
<a name="l00203"></a><a class="code" href="structdatapoint.html#020ec35c899ccbceb21c67ccde510b7c">00203</a> <span class="comment"></span>        <span class="keywordtype">void</span> <a class="code" href="structdatapoint.html#020ec35c899ccbceb21c67ccde510b7c" title="This code reads a stringified representation of the feature vector and converts it...">pack_trits</a>(<span class="keyword">const</span> <span class="keywordtype">string</span>&amp; unpacked)
<a name="l00204"></a>00204         {
<a name="l00205"></a>00205             <a class="code" href="structdatapoint.html#9d664f9582856d6f8f4d0e707a37e584" title="Used to store the ternary vector Ternary bits are stored using 3 out of the 4 values...">tests</a> = 0;
<a name="l00206"></a>00206             <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0;i &lt; unpacked.size(); i++)
<a name="l00207"></a>00207             {
<a name="l00208"></a>00208                 <span class="keywordflow">if</span>(unpacked[i] == <span class="charliteral">'b'</span>)
<a name="l00209"></a>00209                     <a class="code" href="structdatapoint.html#92958c8c67f7ea4c08f2d2b4678698c4" title="Set a ternary digit.">set_trit</a>(i, <a class="code" href="learn__fast__tree_8cc.html#5475d259eeee26da1b2bcffcc581ebcd921c8fbda165a3c2613fe9e6d75102d0">Brighter</a>);
<a name="l00210"></a>00210                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(unpacked[i] == <span class="charliteral">'d'</span>)
<a name="l00211"></a>00211                     <a class="code" href="structdatapoint.html#92958c8c67f7ea4c08f2d2b4678698c4" title="Set a ternary digit.">set_trit</a>(i, <a class="code" href="learn__fast__tree_8cc.html#5475d259eeee26da1b2bcffcc581ebcd419a3322847cb783c0050a64a1df8743">Darker</a>);
<a name="l00212"></a>00212                 <span class="keywordflow">else</span> <span class="keywordflow">if</span>(unpacked[i] == <span class="charliteral">'s'</span>)
<a name="l00213"></a>00213                     <a class="code" href="structdatapoint.html#92958c8c67f7ea4c08f2d2b4678698c4" title="Set a ternary digit.">set_trit</a>(i, <a class="code" href="learn__fast__tree_8cc.html#5475d259eeee26da1b2bcffcc581ebcdbf5e6bccdc838bc194a062b340d0d1fc">Similar</a>);
<a name="l00214"></a>00214                 <span class="keywordflow">else</span>
<a name="l00215"></a>00215                     <a class="code" href="group__gUtility.html#g9a3d9e758aa01b90e2067121300f17d2" title="Print an error message and the exit.">fatal</a>(2, <span class="stringliteral">"Bad char while packing datapoint: %s"</span>, unpacked);
<a name="l00216"></a>00216             }
<a name="l00217"></a>00217         }
<a name="l00218"></a>00218         <span class="comment"></span>
<a name="l00219"></a>00219 <span class="comment">        ///Set a ternary digit.</span>
<a name="l00220"></a>00220 <span class="comment">        ///@param tnum Digit to set</span>
<a name="l00221"></a>00221 <span class="comment">        ///@param val Value to set it to.</span>
<a name="l00222"></a><a class="code" href="structdatapoint.html#92958c8c67f7ea4c08f2d2b4678698c4">00222</a> <span class="comment"></span>        <span class="keywordtype">void</span> <a class="code" href="structdatapoint.html#92958c8c67f7ea4c08f2d2b4678698c4" title="Set a ternary digit.">set_trit</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> tnum, <a class="code" href="learn__fast__tree_8cc.html#5475d259eeee26da1b2bcffcc581ebcd" title="Representations of ternary digits.">Ternary</a> val)
<a name="l00223"></a>00223         {
<a name="l00224"></a>00224             assert(val == <a class="code" href="learn__fast__tree_8cc.html#5475d259eeee26da1b2bcffcc581ebcd921c8fbda165a3c2613fe9e6d75102d0">Brighter</a> || val == <a class="code" href="learn__fast__tree_8cc.html#5475d259eeee26da1b2bcffcc581ebcd419a3322847cb783c0050a64a1df8743">Darker</a> || val == <a class="code" href="learn__fast__tree_8cc.html#5475d259eeee26da1b2bcffcc581ebcdbf5e6bccdc838bc194a062b340d0d1fc">Similar</a>);
<a name="l00225"></a>00225             assert(tnum &lt; <a class="code" href="structdatapoint.html#8c13f00e5ac2cb38b86b6185d0357457" title="Maximum number of features representable.">max_size</a>);
<a name="l00226"></a>00226 
<a name="l00227"></a>00227             <span class="keywordflow">if</span>(val == <a class="code" href="learn__fast__tree_8cc.html#5475d259eeee26da1b2bcffcc581ebcd921c8fbda165a3c2613fe9e6d75102d0">Brighter</a>)
<a name="l00228"></a>00228                 <a class="code" href="structdatapoint.html#9d664f9582856d6f8f4d0e707a37e584" title="Used to store the ternary vector Ternary bits are stored using 3 out of the 4 values...">tests</a>[tnum] = 1;
<a name="l00229"></a>00229             <span class="keywordflow">else</span> <span class="keywordflow">if</span>(val == <a class="code" href="learn__fast__tree_8cc.html#5475d259eeee26da1b2bcffcc581ebcd419a3322847cb783c0050a64a1df8743">Darker</a>)
<a name="l00230"></a>00230                 <a class="code" href="structdatapoint.html#9d664f9582856d6f8f4d0e707a37e584" title="Used to store the ternary vector Ternary bits are stored using 3 out of the 4 values...">tests</a>[tnum + <a class="code" href="structdatapoint.html#8c13f00e5ac2cb38b86b6185d0357457" title="Maximum number of features representable.">max_size</a>] = 1;
<a name="l00231"></a>00231         }
<a name="l00232"></a>00232 };
<a name="l00233"></a>00233 <span class="comment"></span>
<a name="l00234"></a>00234 <span class="comment">/**</span>
<a name="l00235"></a>00235 <span class="comment">This function loads as many datapoints from the standard input as </span>
<a name="l00236"></a>00236 <span class="comment">possible. Datapoints consist of a feature vector (a string containing the</span>
<a name="l00237"></a>00237 <span class="comment">characters "b", "d" and "s"), a number of instances and a class.</span>
<a name="l00238"></a>00238 <span class="comment"></span>
<a name="l00239"></a>00239 <span class="comment">See datapoint::pack_trits for a more complete description of the feature vector.</span>
<a name="l00240"></a>00240 <span class="comment"></span>
<a name="l00241"></a>00241 <span class="comment">The tokens are whitespace separated.</span>
<a name="l00242"></a>00242 <span class="comment"></span>
<a name="l00243"></a>00243 <span class="comment">@param nfeats Number of features in a feature vector. Used to spot errors.</span>
<a name="l00244"></a>00244 <span class="comment">@return Loaded datapoints and total number of instances.</span>
<a name="l00245"></a>00245 <span class="comment">*/</span>
<a name="l00246"></a><a class="code" href="learn__fast__tree_8cc.html#157228e398bf6b3e094f87e36915e742">00246</a> <span class="keyword">template</span>&lt;<span class="keywordtype">int</span> S&gt; <span class="keyword">typename</span> V_tuple&lt;shared_ptr&lt;vector&lt;datapoint&lt;S&gt; &gt; &gt;, uint64_t &gt;::type <a class="code" href="learn__fast__tree_8cc.html#157228e398bf6b3e094f87e36915e742" title="This function loads as many datapoints from the standard input as possible.">load_features</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nfeats)
<a name="l00247"></a>00247 {
<a name="l00248"></a>00248     shared_ptr&lt;vector&lt;datapoint&lt;S&gt; &gt; &gt; ret(<span class="keyword">new</span> vector&lt;<a class="code" href="structdatapoint.html" title="This structure represents a datapoint.">datapoint&lt;S&gt;</a> &gt;);
<a name="l00249"></a>00249 
<a name="l00250"></a>00250 
<a name="l00251"></a>00251     <span class="keywordtype">string</span> unpacked_feature;
<a name="l00252"></a>00252     
<a name="l00253"></a>00253     uint64_t total_num = 0;
<a name="l00254"></a>00254 
<a name="l00255"></a>00255     uint64_t line_num=2;
<a name="l00256"></a>00256 
<a name="l00257"></a>00257     <span class="keywordflow">for</span>(;;)
<a name="l00258"></a>00258     {
<a name="l00259"></a>00259         uint64_t count;
<a name="l00260"></a>00260         <span class="keywordtype">bool</span> is;
<a name="l00261"></a>00261 
<a name="l00262"></a>00262         cin &gt;&gt; unpacked_feature &gt;&gt; count &gt;&gt; is;
<a name="l00263"></a>00263 
<a name="l00264"></a>00264         <span class="keywordflow">if</span>(!cin)
<a name="l00265"></a>00265             <span class="keywordflow">break</span>;
<a name="l00266"></a>00266 
<a name="l00267"></a>00267         line_num++;
<a name="l00268"></a>00268 
<a name="l00269"></a>00269         <span class="keywordflow">if</span>(unpacked_feature.size() != nfeats)
<a name="l00270"></a>00270             <a class="code" href="group__gUtility.html#g9a3d9e758aa01b90e2067121300f17d2" title="Print an error message and the exit.">fatal</a>(1, <span class="stringliteral">"Feature string length is %i, not %i on line %i"</span>, unpacked_feature.size(), nfeats, line_num);
<a name="l00271"></a>00271 
<a name="l00272"></a>00272         <span class="keywordflow">if</span>(count == 0)
<a name="l00273"></a>00273             <a class="code" href="group__gUtility.html#g9a3d9e758aa01b90e2067121300f17d2" title="Print an error message and the exit.">fatal</a>(4, <span class="stringliteral">"Zero count is invalid"</span>);
<a name="l00274"></a>00274 
<a name="l00275"></a>00275         ret-&gt;push_back(<a class="code" href="structdatapoint.html" title="This structure represents a datapoint.">datapoint&lt;S&gt;</a>(unpacked_feature, count, is));
<a name="l00276"></a>00276 
<a name="l00277"></a>00277         total_num += count;
<a name="l00278"></a>00278     }
<a name="l00279"></a>00279 
<a name="l00280"></a>00280     cerr &lt;&lt; <span class="stringliteral">"Num features: "</span> &lt;&lt; total_num &lt;&lt; endl
<a name="l00281"></a>00281          &lt;&lt; <span class="stringliteral">"Num distinct: "</span> &lt;&lt; ret-&gt;size() &lt;&lt; endl;
<a name="l00282"></a>00282 
<a name="l00283"></a>00283     <span class="keywordflow">return</span> make_vtuple(ret, total_num);
<a name="l00284"></a>00284 }
<a name="l00285"></a>00285 
<a name="l00286"></a>00286 <span class="comment"></span>
<a name="l00287"></a>00287 <span class="comment">///Compute the entropy of a set with binary annotations.</span>
<a name="l00288"></a>00288 <span class="comment">///@param n Number of elements in the set</span>
<a name="l00289"></a>00289 <span class="comment">///@param c1 Number of elements in class 1</span>
<a name="l00290"></a>00290 <span class="comment">///@return The set entropy.</span>
<a name="l00291"></a><a class="code" href="learn__fast__tree_8cc.html#9f5a3512e4c78a92da4ba7aaaaaf095f">00291</a> <span class="comment"></span><span class="keywordtype">double</span> <a class="code" href="learn__fast__tree_8cc.html#9f5a3512e4c78a92da4ba7aaaaaf095f" title="Compute the entropy of a set with binary annotations.">entropy</a>(uint64_t n, uint64_t c1)
<a name="l00292"></a>00292 {
<a name="l00293"></a>00293     assert(c1 &lt;= n);
<a name="l00294"></a>00294     <span class="comment">//n is total number, c1 in num in class 1</span>
<a name="l00295"></a>00295     <span class="keywordflow">if</span>(n == 0)
<a name="l00296"></a>00296         <span class="keywordflow">return</span> 0;
<a name="l00297"></a>00297     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(c1 == 0 || c1 == n)
<a name="l00298"></a>00298         <span class="keywordflow">return</span> 0;
<a name="l00299"></a>00299     <span class="keywordflow">else</span>
<a name="l00300"></a>00300     {
<a name="l00301"></a>00301         <span class="keywordtype">double</span> p1 = (double)c1 / n;
<a name="l00302"></a>00302         <span class="keywordtype">double</span> p2 = 1-p1;
<a name="l00303"></a>00303 
<a name="l00304"></a>00304         <span class="keywordflow">return</span> -(double)n*(p1*log(p1) + p2*log(p2)) / log(2.f);
<a name="l00305"></a>00305     }
<a name="l00306"></a>00306 }
<a name="l00307"></a>00307 <span class="comment"></span>
<a name="l00308"></a>00308 <span class="comment">///Find the feature that has the highest weighted entropy change.</span>
<a name="l00309"></a>00309 <span class="comment">///@param fs datapoints to split in to three subsets.</span>
<a name="l00310"></a>00310 <span class="comment">///@param weights weights on features</span>
<a name="l00311"></a>00311 <span class="comment">///@param nfeats Number of features in use.</span>
<a name="l00312"></a>00312 <span class="comment">///@return best feature.</span>
<a name="l00313"></a><a class="code" href="learn__fast__tree_8cc.html#ce3ca018f064f7d82baab3d67529ab5d">00313</a> <span class="comment"></span><span class="keyword">template</span>&lt;<span class="keywordtype">int</span> S&gt; <span class="keywordtype">int</span> <a class="code" href="learn__fast__tree_8cc.html#ce3ca018f064f7d82baab3d67529ab5d" title="Find the feature that has the highest weighted entropy change.">find_best_split</a>(<span class="keyword">const</span> vector&lt;<a class="code" href="structdatapoint.html" title="This structure represents a datapoint.">datapoint&lt;S&gt;</a> &gt;&amp; fs, <span class="keyword">const</span> vector&lt;double&gt;&amp; weights, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nfeats)
<a name="l00314"></a>00314 {
<a name="l00315"></a>00315     assert(nfeats == weights.size());
<a name="l00316"></a>00316     uint64_t num_total = 0, num_corners=0;
<a name="l00317"></a>00317 
<a name="l00318"></a>00318     <span class="keywordflow">for</span>(<span class="keyword">typename</span> vector&lt;<a class="code" href="structdatapoint.html" title="This structure represents a datapoint.">datapoint&lt;S&gt;</a> &gt;::const_iterator i=fs.begin(); i != fs.end(); i++)
<a name="l00319"></a>00319     {
<a name="l00320"></a>00320         num_total += i-&gt;count;
<a name="l00321"></a>00321         <span class="keywordflow">if</span>(i-&gt;is_a_corner)
<a name="l00322"></a>00322             num_corners += i-&gt;count;
<a name="l00323"></a>00323     }
<a name="l00324"></a>00324 
<a name="l00325"></a>00325     <span class="keywordtype">double</span> total_entropy = <a class="code" href="learn__fast__tree_8cc.html#9f5a3512e4c78a92da4ba7aaaaaf095f" title="Compute the entropy of a set with binary annotations.">entropy</a>(num_total, num_corners);
<a name="l00326"></a>00326     
<a name="l00327"></a>00327     <span class="keywordtype">double</span> biggest_delta = 0;
<a name="l00328"></a>00328     <span class="keywordtype">int</span>   feature_num = -1;
<a name="l00329"></a>00329 
<a name="l00330"></a>00330     <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i &lt; nfeats; i++)
<a name="l00331"></a>00331     {
<a name="l00332"></a>00332         uint64_t num_bri = 0, num_dar = 0, num_sim = 0;
<a name="l00333"></a>00333         uint64_t cor_bri = 0, cor_dar = 0, cor_sim = 0;
<a name="l00334"></a>00334 
<a name="l00335"></a>00335         <span class="keywordflow">for</span>(<span class="keyword">typename</span> vector&lt;<a class="code" href="structdatapoint.html" title="This structure represents a datapoint.">datapoint&lt;S&gt;</a> &gt;::const_iterator f=fs.begin(); f != fs.end(); f++)
<a name="l00336"></a>00336         {
<a name="l00337"></a>00337             <span class="keywordflow">switch</span>(f-&gt;get_trit(i))
<a name="l00338"></a>00338             {
<a name="l00339"></a>00339                 <span class="keywordflow">case</span> <a class="code" href="learn__fast__tree_8cc.html#5475d259eeee26da1b2bcffcc581ebcd921c8fbda165a3c2613fe9e6d75102d0">Brighter</a>:
<a name="l00340"></a>00340                     num_bri += f-&gt;count;
<a name="l00341"></a>00341                     <span class="keywordflow">if</span>(f-&gt;is_a_corner)
<a name="l00342"></a>00342                         cor_bri += f-&gt;count;
<a name="l00343"></a>00343                     <span class="keywordflow">break</span>;
<a name="l00344"></a>00344 
<a name="l00345"></a>00345                 <span class="keywordflow">case</span> <a class="code" href="learn__fast__tree_8cc.html#5475d259eeee26da1b2bcffcc581ebcd419a3322847cb783c0050a64a1df8743">Darker</a>:
<a name="l00346"></a>00346                     num_dar += f-&gt;count;
<a name="l00347"></a>00347                     <span class="keywordflow">if</span>(f-&gt;is_a_corner)
<a name="l00348"></a>00348                         cor_dar += f-&gt;count;
<a name="l00349"></a>00349                     <span class="keywordflow">break</span>;
<a name="l00350"></a>00350 
<a name="l00351"></a>00351                 <span class="keywordflow">case</span> <a class="code" href="learn__fast__tree_8cc.html#5475d259eeee26da1b2bcffcc581ebcdbf5e6bccdc838bc194a062b340d0d1fc">Similar</a>:
<a name="l00352"></a>00352                     num_sim += f-&gt;count;
<a name="l00353"></a>00353                     <span class="keywordflow">if</span>(f-&gt;is_a_corner)
<a name="l00354"></a>00354                         cor_sim += f-&gt;count;
<a name="l00355"></a>00355                     <span class="keywordflow">break</span>;
<a name="l00356"></a>00356             }
<a name="l00357"></a>00357         }
<a name="l00358"></a>00358 
<a name="l00359"></a>00359         <span class="keywordtype">double</span> delta_e = total_entropy - (<a class="code" href="learn__fast__tree_8cc.html#9f5a3512e4c78a92da4ba7aaaaaf095f" title="Compute the entropy of a set with binary annotations.">entropy</a>(num_bri, cor_bri) + <a class="code" href="learn__fast__tree_8cc.html#9f5a3512e4c78a92da4ba7aaaaaf095f" title="Compute the entropy of a set with binary annotations.">entropy</a>(num_dar, cor_dar) + <a class="code" href="learn__fast__tree_8cc.html#9f5a3512e4c78a92da4ba7aaaaaf095f" title="Compute the entropy of a set with binary annotations.">entropy</a>(num_sim, cor_sim));
<a name="l00360"></a>00360 
<a name="l00361"></a>00361         delta_e *= weights[i];
<a name="l00362"></a>00362 
<a name="l00363"></a>00363         <span class="keywordflow">if</span>(delta_e &gt; biggest_delta)
<a name="l00364"></a>00364         {       
<a name="l00365"></a>00365             biggest_delta = delta_e;
<a name="l00366"></a>00366             feature_num = i;
<a name="l00367"></a>00367         }   
<a name="l00368"></a>00368     }
<a name="l00369"></a>00369 
<a name="l00370"></a>00370     <span class="keywordflow">if</span>(feature_num == -1)
<a name="l00371"></a>00371         <a class="code" href="group__gUtility.html#g9a3d9e758aa01b90e2067121300f17d2" title="Print an error message and the exit.">fatal</a>(3, <span class="stringliteral">"Couldn't find a split."</span>);
<a name="l00372"></a>00372 
<a name="l00373"></a>00373     <span class="keywordflow">return</span> feature_num;
<a name="l00374"></a>00374 }
<a name="l00375"></a>00375 
<a name="l00376"></a>00376 <span class="comment"></span>
<a name="l00377"></a>00377 <span class="comment">////////////////////////////////////////////////////////////////////////////////</span>
<a name="l00378"></a>00378 <span class="comment"></span><span class="comment">//</span>
<a name="l00379"></a>00379 <span class="comment">// Tree buliding</span>
<a name="l00380"></a>00380 <span class="comment">//</span>
<a name="l00381"></a>00381 <span class="comment"></span>
<a name="l00382"></a>00382 <span class="comment">///This class represents a decision tree.</span>
<a name="l00383"></a>00383 <span class="comment">///Each leaf node contains a class, being Corner or NonCorner.</span>
<a name="l00384"></a>00384 <span class="comment">///Each decision node contains a feature about which to make a ternary decision.</span>
<a name="l00385"></a>00385 <span class="comment">///Additionally, each node records how many datapoints were tested.</span>
<a name="l00386"></a>00386 <span class="comment">///The generated tree structure is not mutable.</span>
<a name="l00387"></a><a class="code" href="structtree.html">00387</a> <span class="comment"></span><span class="keyword">struct </span><a class="code" href="structtree.html" title="This class represents a decision tree.">tree</a>{<span class="comment"></span>
<a name="l00388"></a>00388 <span class="comment">    ///The class of the leaf, and a sentinal to indacate that the node is</span>
<a name="l00389"></a>00389 <span class="comment">    ///not a leaf. Now that I come back to this, it looks suspiciously like</span>
<a name="l00390"></a>00390 <span class="comment">    ///an instance of http://thedailywtf.com/Articles/What_Is_Truth_0x3f_.aspx</span>
<a name="l00391"></a>00391 <span class="comment">    ///Oh well.</span>
<a name="l00392"></a><a class="code" href="structtree.html#b5c56b6f06ca97e05a0279bc160b5ac0">00392</a> <span class="comment"></span>    <span class="keyword">enum</span> <a class="code" href="structtree.html#b5c56b6f06ca97e05a0279bc160b5ac0" title="The class of the leaf, and a sentinal to indacate that the node is not a leaf.">IsCorner</a>
<a name="l00393"></a>00393     {
<a name="l00394"></a><a class="code" href="structtree.html#b5c56b6f06ca97e05a0279bc160b5ac067ff8625432546cee52c13791b5aa44a">00394</a>         <a class="code" href="structtree.html#b5c56b6f06ca97e05a0279bc160b5ac067ff8625432546cee52c13791b5aa44a">Corner</a>,
<a name="l00395"></a><a class="code" href="structtree.html#b5c56b6f06ca97e05a0279bc160b5ac00572318008570e7add7191eabe4309f3">00395</a>         <a class="code" href="structtree.html#b5c56b6f06ca97e05a0279bc160b5ac00572318008570e7add7191eabe4309f3">NonCorner</a>,
<a name="l00396"></a><a class="code" href="structtree.html#b5c56b6f06ca97e05a0279bc160b5ac0edc2eb63a8d84c23a98d50319c78508f">00396</a>         <a class="code" href="structtree.html#b5c56b6f06ca97e05a0279bc160b5ac0edc2eb63a8d84c23a98d50319c78508f">NonTerminal</a>
<a name="l00397"></a>00397     };
<a name="l00398"></a>00398 
<a name="l00399"></a><a class="code" href="structtree.html#92cf3beb390f661b4c5486592013b140">00399</a>     <span class="keyword">const</span> shared_ptr&lt;tree&gt; <a class="code" href="structtree.html#92cf3beb390f661b4c5486592013b140" title="Subtrees.">brighter</a>;                  <span class="comment">///&lt;Subtrees</span>
<a name="l00400"></a><a class="code" href="structtree.html#1f6f3125c2fab213da95dfdf530c13dc">00400</a> <span class="comment"></span>    <span class="keyword">const</span> shared_ptr&lt;tree&gt; <a class="code" href="structtree.html#1f6f3125c2fab213da95dfdf530c13dc" title="Subtrees.">darker</a>;                    <span class="comment">///&lt;Subtrees</span>
<a name="l00401"></a><a class="code" href="structtree.html#19c5e5fecea332fce87f03fa7e5929f5">00401</a> <span class="comment"></span>    <span class="keyword">const</span> shared_ptr&lt;tree&gt; <a class="code" href="structtree.html#19c5e5fecea332fce87f03fa7e5929f5" title="Subtrees.">similar</a>;                   <span class="comment">///&lt;Subtrees</span>
<a name="l00402"></a><a class="code" href="structtree.html#2b87abfe9d4b7855a69e7f6cd741ae0d">00402</a> <span class="comment"></span>    <span class="keyword">const</span> <a class="code" href="structtree.html#b5c56b6f06ca97e05a0279bc160b5ac0" title="The class of the leaf, and a sentinal to indacate that the node is not a leaf.">IsCorner</a> <a class="code" href="structtree.html#2b87abfe9d4b7855a69e7f6cd741ae0d" title="Class of this node (if its a leaf).">is_a_corner</a>;                       <span class="comment">///&lt;Class of this node (if its a leaf)</span>
<a name="l00403"></a><a class="code" href="structtree.html#1a36930bec5910f253a8961838481713">00403</a> <span class="comment"></span>    <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="structtree.html#1a36930bec5910f253a8961838481713" title="Feature (ie pixel) to test if this is a non-leaf.">feature_to_test</a>;                        <span class="comment">///&lt;Feature (ie pixel) to test if this  is a non-leaf.</span>
<a name="l00404"></a><a class="code" href="structtree.html#ce82fc013bf129de16ea47ccaddc64d1">00404</a> <span class="comment"></span>    <span class="keyword">const</span> uint64_t <a class="code" href="structtree.html#ce82fc013bf129de16ea47ccaddc64d1" title="Number of datapoints passing through this node.">num_datapoints</a>;                    <span class="comment">///&lt;Number of datapoints passing through this node.</span>
<a name="l00405"></a>00405 <span class="comment"></span><span class="comment"></span>
<a name="l00406"></a>00406 <span class="comment">    ///Convert the tree to a simple string representation.</span>
<a name="l00407"></a>00407 <span class="comment">    ///This is allows comparison of two trees to see if they are the same.</span>
<a name="l00408"></a>00408 <span class="comment">    ///It's probably rather inefficient to hammer the string class compared</span>
<a name="l00409"></a>00409 <span class="comment">    ///to using an ostringstream, but this is not the slowest part of the program.</span>
<a name="l00410"></a>00410 <span class="comment">    ///@return a stringified tree representation</span>
<a name="l00411"></a><a class="code" href="structtree.html#39ab3cab6fd8d72ec50a396ae480cc45">00411</a> <span class="comment"></span>    <span class="keywordtype">string</span> <a class="code" href="structtree.html#39ab3cab6fd8d72ec50a396ae480cc45" title="Convert the tree to a simple string representation.">stringify</a>()
<a name="l00412"></a>00412     {
<a name="l00413"></a>00413         <span class="keywordflow">if</span>(<a class="code" href="structtree.html#2b87abfe9d4b7855a69e7f6cd741ae0d" title="Class of this node (if its a leaf).">is_a_corner</a> == <a class="code" href="structtree.html#b5c56b6f06ca97e05a0279bc160b5ac0edc2eb63a8d84c23a98d50319c78508f">NonTerminal</a>)
<a name="l00414"></a>00414             <span class="keywordflow">return</span> <span class="stringliteral">"("</span> + <a class="code" href="structtree.html#92cf3beb390f661b4c5486592013b140" title="Subtrees.">brighter</a>-&gt;stringify() + <a class="code" href="structtree.html#1f6f3125c2fab213da95dfdf530c13dc" title="Subtrees.">darker</a>-&gt;stringify() + <a class="code" href="structtree.html#19c5e5fecea332fce87f03fa7e5929f5" title="Subtrees.">similar</a>-&gt;stringify() + <span class="stringliteral">")"</span>;
<a name="l00415"></a>00415         <span class="keywordflow">else</span>
<a name="l00416"></a>00416             <span class="keywordflow">return</span> string(<span class="stringliteral">"("</span>) + (<a class="code" href="structtree.html#2b87abfe9d4b7855a69e7f6cd741ae0d" title="Class of this node (if its a leaf).">is_a_corner</a> == <a class="code" href="structtree.html#b5c56b6f06ca97e05a0279bc160b5ac067ff8625432546cee52c13791b5aa44a">Corner</a>?<span class="stringliteral">"1"</span>:<span class="stringliteral">"0"</span>)  +  <span class="stringliteral">")"</span>;
<a name="l00417"></a>00417     }
<a name="l00418"></a>00418 <span class="comment"></span>
<a name="l00419"></a>00419 <span class="comment">    ///Create a leaf node which is a corner</span>
<a name="l00420"></a>00420 <span class="comment">    ///This special constructor function makes it impossible to </span>
<a name="l00421"></a>00421 <span class="comment">    ///construct a leaf with the NonTerminal class.</span>
<a name="l00422"></a>00422 <span class="comment">    ///@param n number of datapoints reaching this node.</span>
<a name="l00423"></a><a class="code" href="structtree.html#74c9eeb0ffb179a31cb5b9bff030210a">00423</a> <span class="comment"></span>    <span class="keyword">static</span> shared_ptr&lt;tree&gt; <a class="code" href="structtree.html#74c9eeb0ffb179a31cb5b9bff030210a" title="Create a leaf node which is a corner This special constructor function makes it impossible...">CornerLeaf</a>(uint64_t n)
<a name="l00424"></a>00424     {
<a name="l00425"></a>00425         <span class="keywordflow">return</span> shared_ptr&lt;tree&gt;(<span class="keyword">new</span> <a class="code" href="structtree.html#812b98976fbcf1a4d25d3d416af727bc" title="Create a non-leaf node.">tree</a>(<a class="code" href="structtree.html#b5c56b6f06ca97e05a0279bc160b5ac067ff8625432546cee52c13791b5aa44a">Corner</a>, n));
<a name="l00426"></a>00426     }
<a name="l00427"></a>00427     <span class="comment"></span>
<a name="l00428"></a>00428 <span class="comment">    ///Creat a leaf node which is a non-corner</span>
<a name="l00429"></a>00429 <span class="comment">    ///This special constructor function makes it impossible to </span>
<a name="l00430"></a>00430 <span class="comment">    ///construct a leaf with the NonTerminal class.</span>
<a name="l00431"></a>00431 <span class="comment">    ///@param n number of datapoints reaching this node.</span>
<a name="l00432"></a><a class="code" href="structtree.html#d2580fd524ddba00a5579fa2062cb4e8">00432</a> <span class="comment"></span>    <span class="keyword">static</span> shared_ptr&lt;tree&gt; <a class="code" href="structtree.html#d2580fd524ddba00a5579fa2062cb4e8" title="Creat a leaf node which is a non-corner This special constructor function makes it...">NonCornerLeaf</a>(uint64_t n)
<a name="l00433"></a>00433     {
<a name="l00434"></a>00434         <span class="keywordflow">return</span> shared_ptr&lt;tree&gt;(<span class="keyword">new</span> <a class="code" href="structtree.html#812b98976fbcf1a4d25d3d416af727bc" title="Create a non-leaf node.">tree</a>(<a class="code" href="structtree.html#b5c56b6f06ca97e05a0279bc160b5ac00572318008570e7add7191eabe4309f3">NonCorner</a>, n));
<a name="l00435"></a>00435     }
<a name="l00436"></a>00436     <span class="comment"></span>
<a name="l00437"></a>00437 <span class="comment">    ///Create a non-leaf node</span>
<a name="l00438"></a>00438 <span class="comment">    ///@param b The brighter subtree</span>
<a name="l00439"></a>00439 <span class="comment">    ///@param d The darker subtree</span>
<a name="l00440"></a>00440 <span class="comment">    ///@param s The similar subtree</span>
<a name="l00441"></a>00441 <span class="comment">    ///@param n Feature number to test</span>
<a name="l00442"></a>00442 <span class="comment">    ///@param num Number of datapoints reaching this node.</span>
<a name="l00443"></a><a class="code" href="structtree.html#812b98976fbcf1a4d25d3d416af727bc">00443</a> <span class="comment"></span>    <a class="code" href="structtree.html#812b98976fbcf1a4d25d3d416af727bc" title="Create a non-leaf node.">tree</a>(shared_ptr&lt;tree&gt; b, shared_ptr&lt;tree&gt; d, shared_ptr&lt;tree&gt; s, <span class="keywordtype">int</span> n, uint64_t num)
<a name="l00444"></a>00444     :<a class="code" href="structtree.html#92cf3beb390f661b4c5486592013b140" title="Subtrees.">brighter</a>(b), <a class="code" href="structtree.html#1f6f3125c2fab213da95dfdf530c13dc" title="Subtrees.">darker</a>(d), <a class="code" href="structtree.html#19c5e5fecea332fce87f03fa7e5929f5" title="Subtrees.">similar</a>(s), <a class="code" href="structtree.html#2b87abfe9d4b7855a69e7f6cd741ae0d" title="Class of this node (if its a leaf).">is_a_corner</a>(<a class="code" href="structtree.html#b5c56b6f06ca97e05a0279bc160b5ac0edc2eb63a8d84c23a98d50319c78508f">NonTerminal</a>), <a class="code" href="structtree.html#1a36930bec5910f253a8961838481713" title="Feature (ie pixel) to test if this is a non-leaf.">feature_to_test</a>(n), <a class="code" href="structtree.html#ce82fc013bf129de16ea47ccaddc64d1" title="Number of datapoints passing through this node.">num_datapoints</a>(num)
<a name="l00445"></a>00445     {}
<a name="l00446"></a>00446 
<a name="l00447"></a>00447     <span class="keyword">private</span>:<span class="comment"></span>
<a name="l00448"></a>00448 <span class="comment">    ///The leaf node constructor is private to prevent a tree</span>
<a name="l00449"></a>00449 <span class="comment">    ///being constructed with invalid values.</span>
<a name="l00450"></a>00450 <span class="comment">    ///see also CornerLeaf and NonCornerLeaf.</span>
<a name="l00451"></a>00451 <span class="comment">    ///@param c Class of the node</span>
<a name="l00452"></a>00452 <span class="comment">    ///@param n Number of datapoints which this node represents</span>
<a name="l00453"></a><a class="code" href="structtree.html#dd16029847bed5059a1fde0131479f5c">00453</a> <span class="comment"></span>    <a class="code" href="structtree.html#812b98976fbcf1a4d25d3d416af727bc" title="Create a non-leaf node.">tree</a>(<a class="code" href="structtree.html#b5c56b6f06ca97e05a0279bc160b5ac0" title="The class of the leaf, and a sentinal to indacate that the node is not a leaf.">IsCorner</a> c, uint64_t n)
<a name="l00454"></a>00454     :<a class="code" href="structtree.html#2b87abfe9d4b7855a69e7f6cd741ae0d" title="Class of this node (if its a leaf).">is_a_corner</a>(c),<a class="code" href="structtree.html#1a36930bec5910f253a8961838481713" title="Feature (ie pixel) to test if this is a non-leaf.">feature_to_test</a>(-1),<a class="code" href="structtree.html#ce82fc013bf129de16ea47ccaddc64d1" title="Number of datapoints passing through this node.">num_datapoints</a>(n)
<a name="l00455"></a>00455     {}
<a name="l00456"></a>00456 };
<a name="l00457"></a>00457 
<a name="l00458"></a>00458 <span class="comment"></span>
<a name="l00459"></a>00459 <span class="comment">///This function uses ID3 to construct a decision tree. The entropy changes</span>
<a name="l00460"></a>00460 <span class="comment">///are weighted by the list of weights, to allow bias towards certain features.</span>
<a name="l00461"></a>00461 <span class="comment">///This function assumes that the class is an exact function of the data. If </span>
<a name="l00462"></a>00462 <span class="comment">///there datapoints with different classes share the same feature vector, the program</span>
<a name="l00463"></a>00463 <span class="comment">///will crash with error code 3.</span>
<a name="l00464"></a>00464 <span class="comment">///@param corners Datapoints in this part of the subtree to classify</span>
<a name="l00465"></a>00465 <span class="comment">///@param weights Weights on the features</span>
<a name="l00466"></a>00466 <span class="comment">///@param nfeats Number of features actually used</span>
<a name="l00467"></a>00467 <span class="comment">///@return The tree required to classify corners</span>
<a name="l00468"></a><a class="code" href="learn__fast__tree_8cc.html#cdf532026168bb78545e9111afa2f008">00468</a> <span class="comment"></span><span class="keyword">template</span>&lt;<span class="keywordtype">int</span> S&gt; shared_ptr&lt;tree&gt; <a class="code" href="learn__fast__tree_8cc.html#cdf532026168bb78545e9111afa2f008" title="This function uses ID3 to construct a decision tree.">build_tree</a>(vector&lt;<a class="code" href="structdatapoint.html" title="This structure represents a datapoint.">datapoint&lt;S&gt;</a> &gt;&amp; corners, <span class="keyword">const</span> vector&lt;double&gt;&amp; weights, <span class="keywordtype">int</span> nfeats)
<a name="l00469"></a>00469 {
<a name="l00470"></a>00470     <span class="comment">//Find the split</span>
<a name="l00471"></a>00471     <span class="keywordtype">int</span> f = find_best_split&lt;S&gt;(corners, weights, nfeats);
<a name="l00472"></a>00472 
<a name="l00473"></a>00473     <span class="comment">//Split corners in to the three chunks, based on the result of find_best_split.</span>
<a name="l00474"></a>00474     <span class="comment">//Also, count how many of each class ends up in each of the three bins.</span>
<a name="l00475"></a>00475     <span class="comment">//It may apper to be inefficient to use a vector here instead of a list, in terms</span>
<a name="l00476"></a>00476     <span class="comment">//of memory, but the per-element storage overhead of the list is such that it uses</span>
<a name="l00477"></a>00477     <span class="comment">//considerably more memory and is much slower.</span>
<a name="l00478"></a>00478     vector&lt;datapoint&lt;S&gt; &gt; brighter, darker, similar;
<a name="l00479"></a>00479     uint64_t num_bri=0, cor_bri=0, num_dar=0, cor_dar=0, num_sim=0, cor_sim=0;
<a name="l00480"></a>00480 
<a name="l00481"></a>00481     <span class="keywordflow">for</span>(<span class="keywordtype">size_t</span> i=0; i &lt; corners.size(); i++)
<a name="l00482"></a>00482     {
<a name="l00483"></a>00483         <span class="keywordflow">switch</span>(corners[i].get_trit(f))
<a name="l00484"></a>00484         {
<a name="l00485"></a>00485             <span class="keywordflow">case</span> <a class="code" href="learn__fast__tree_8cc.html#5475d259eeee26da1b2bcffcc581ebcd921c8fbda165a3c2613fe9e6d75102d0">Brighter</a>:
<a name="l00486"></a>00486                 brighter.push_back(corners[i]);
<a name="l00487"></a>00487                 num_bri += corners[i].count;
<a name="l00488"></a>00488                 <span class="keywordflow">if</span>(corners[i].is_a_corner)
<a name="l00489"></a>00489                     cor_bri += corners[i].count;
<a name="l00490"></a>00490                 <span class="keywordflow">break</span>;
<a name="l00491"></a>00491 
<a name="l00492"></a>00492             <span class="keywordflow">case</span> <a class="code" href="learn__fast__tree_8cc.html#5475d259eeee26da1b2bcffcc581ebcd419a3322847cb783c0050a64a1df8743">Darker</a>:
<a name="l00493"></a>00493                 darker.push_back(corners[i]);
<a name="l00494"></a>00494                 num_dar += corners[i].count;
<a name="l00495"></a>00495                 <span class="keywordflow">if</span>(corners[i].is_a_corner)
<a name="l00496"></a>00496                     cor_dar += corners[i].count;
<a name="l00497"></a>00497                 <span class="keywordflow">break</span>;
<a name="l00498"></a>00498 
<a name="l00499"></a>00499             <span class="keywordflow">case</span> <a class="code" href="learn__fast__tree_8cc.html#5475d259eeee26da1b2bcffcc581ebcdbf5e6bccdc838bc194a062b340d0d1fc">Similar</a>:
<a name="l00500"></a>00500                 similar.push_back(corners[i]);
<a name="l00501"></a>00501                 num_sim += corners[i].count;
<a name="l00502"></a>00502                 <span class="keywordflow">if</span>(corners[i].is_a_corner)
<a name="l00503"></a>00503                     cor_sim += corners[i].count;
<a name="l00504"></a>00504                 <span class="keywordflow">break</span>;
<a name="l00505"></a>00505         }
<a name="l00506"></a>00506     }
<a name="l00507"></a>00507     
<a name="l00508"></a>00508     <span class="comment">//Deallocate the memory now it's no longer needed.</span>
<a name="l00509"></a>00509     corners.clear();
<a name="l00510"></a>00510     
<a name="l00511"></a>00511     <span class="comment">//This is not the same as corners.size(), since the corners (datapoints)</span>
<a name="l00512"></a>00512     <span class="comment">//have a count assosciated with them.</span>
<a name="l00513"></a>00513     uint64_t num_tests =  num_bri + num_dar + num_sim;
<a name="l00514"></a>00514 
<a name="l00515"></a>00515     
<a name="l00516"></a>00516     <span class="comment">//Build the subtrees</span>
<a name="l00517"></a>00517     shared_ptr&lt;tree&gt; b_tree, d_tree, s_tree;
<a name="l00518"></a>00518 
<a name="l00519"></a>00519     
<a name="l00520"></a>00520     <span class="comment">//If the sublist contains a single class, then instantiate a leaf,</span>
<a name="l00521"></a>00521     <span class="comment">//otherwise recursively build the tree.</span>
<a name="l00522"></a>00522     <span class="keywordflow">if</span>(cor_bri == 0)
<a name="l00523"></a>00523         b_tree = <a class="code" href="structtree.html#d2580fd524ddba00a5579fa2062cb4e8" title="Creat a leaf node which is a non-corner This special constructor function makes it...">tree::NonCornerLeaf</a>(num_bri);
<a name="l00524"></a>00524     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(cor_bri == num_bri)
<a name="l00525"></a>00525         b_tree = <a class="code" href="structtree.html#74c9eeb0ffb179a31cb5b9bff030210a" title="Create a leaf node which is a corner This special constructor function makes it impossible...">tree::CornerLeaf</a>(num_bri);
<a name="l00526"></a>00526     <span class="keywordflow">else</span>
<a name="l00527"></a>00527         b_tree = build_tree&lt;S&gt;(brighter, weights, nfeats);
<a name="l00528"></a>00528     
<a name="l00529"></a>00529 
<a name="l00530"></a>00530     <span class="keywordflow">if</span>(cor_dar == 0)
<a name="l00531"></a>00531         d_tree = <a class="code" href="structtree.html#d2580fd524ddba00a5579fa2062cb4e8" title="Creat a leaf node which is a non-corner This special constructor function makes it...">tree::NonCornerLeaf</a>(num_dar);
<a name="l00532"></a>00532     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(cor_dar == num_dar)
<a name="l00533"></a>00533         d_tree = <a class="code" href="structtree.html#74c9eeb0ffb179a31cb5b9bff030210a" title="Create a leaf node which is a corner This special constructor function makes it impossible...">tree::CornerLeaf</a>(num_dar);
<a name="l00534"></a>00534     <span class="keywordflow">else</span>
<a name="l00535"></a>00535         d_tree = build_tree&lt;S&gt;(darker, weights, nfeats);
<a name="l00536"></a>00536 
<a name="l00537"></a>00537 
<a name="l00538"></a>00538     <span class="keywordflow">if</span>(cor_sim == 0)
<a name="l00539"></a>00539         s_tree = <a class="code" href="structtree.html#d2580fd524ddba00a5579fa2062cb4e8" title="Creat a leaf node which is a non-corner This special constructor function makes it...">tree::NonCornerLeaf</a>(num_sim);
<a name="l00540"></a>00540     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(cor_sim == num_sim)
<a name="l00541"></a>00541         s_tree = <a class="code" href="structtree.html#74c9eeb0ffb179a31cb5b9bff030210a" title="Create a leaf node which is a corner This special constructor function makes it impossible...">tree::CornerLeaf</a>(num_sim);
<a name="l00542"></a>00542     <span class="keywordflow">else</span>
<a name="l00543"></a>00543         s_tree = build_tree&lt;S&gt;(similar, weights, nfeats);
<a name="l00544"></a>00544     
<a name="l00545"></a>00545     <span class="keywordflow">return</span> shared_ptr&lt;tree&gt;(<span class="keyword">new</span> <a class="code" href="structtree.html" title="This class represents a decision tree.">tree</a>(b_tree, d_tree, s_tree, f, num_tests));
<a name="l00546"></a>00546 }
<a name="l00547"></a>00547 
<a name="l00548"></a>00548 <span class="comment"></span>
<a name="l00549"></a>00549 <span class="comment">/**This function traverses the tree and produces a textual representation of it.</span>
<a name="l00550"></a>00550 <span class="comment">Additionally, if any of the subtrees are the same, then a single subtree is produced</span>
<a name="l00551"></a>00551 <span class="comment">and the test is removed.</span>
<a name="l00552"></a>00552 <span class="comment"></span>
<a name="l00553"></a>00553 <span class="comment">A subtree has the following format:</span>
<a name="l00554"></a>00554 <span class="comment">\verbatim </span>
<a name="l00555"></a>00555 <span class="comment">    subtree= lead | node;</span>
<a name="l00556"></a>00556 <span class="comment">    </span>
<a name="l00557"></a>00557 <span class="comment">    leaf = "corner" | "background" ;</span>
<a name="l00558"></a>00558 <span class="comment"></span>
<a name="l00559"></a>00559 <span class="comment">    node = node2 | node3;</span>
<a name="l00560"></a>00560 <span class="comment"></span>
<a name="l00561"></a>00561 <span class="comment">    node3 = "if_brighter" feature_number n1 n2 n3</span>
<a name="l00562"></a>00562 <span class="comment">                subtree</span>
<a name="l00563"></a>00563 <span class="comment">            "elsf_darker" feature_number</span>
<a name="l00564"></a>00564 <span class="comment">                subtree</span>
<a name="l00565"></a>00565 <span class="comment">            "else"</span>
<a name="l00566"></a>00566 <span class="comment">                subtree</span>
<a name="l00567"></a>00567 <span class="comment">            "end";</span>
<a name="l00568"></a>00568 <span class="comment"></span>
<a name="l00569"></a>00569 <span class="comment">     node2= if_statement feature_number n1 n2</span>
<a name="l00570"></a>00570 <span class="comment">                subtree</span>
<a name="l00571"></a>00571 <span class="comment">            "else"</span>
<a name="l00572"></a>00572 <span class="comment">                subtree</span>
<a name="l00573"></a>00573 <span class="comment">            "end";</span>
<a name="l00574"></a>00574 <span class="comment"></span>
<a name="l00575"></a>00575 <span class="comment">    if_statement = "if_brighter" | "if_darker" | "if_either";</span>
<a name="l00576"></a>00576 <span class="comment">    feature_number ==integer;</span>
<a name="l00577"></a>00577 <span class="comment">    n1 = integer;</span>
<a name="l00578"></a>00578 <span class="comment">    n2 = integer;</span>
<a name="l00579"></a>00579 <span class="comment">    n3 = integer;</span>
<a name="l00580"></a>00580 <span class="comment">\endverbatim</span>
<a name="l00581"></a>00581 <span class="comment"></span>
<a name="l00582"></a>00582 <span class="comment">\e feature_number refers to the index of the feature that the test is performed on.</span>
<a name="l00583"></a>00583 <span class="comment"></span>
<a name="l00584"></a>00584 <span class="comment">In \e node3, a 3 way test is performed. \e n1, \e n2 and \e n3 refer to the</span>
<a name="l00585"></a>00585 <span class="comment">number of training examples landing in the \e if block, the \e elfs block and</span>
<a name="l00586"></a>00586 <span class="comment">the \e else block respectivly.</span>
<a name="l00587"></a>00587 <span class="comment"></span>
<a name="l00588"></a>00588 <span class="comment">In a \e node2 node, one of the tests has been removed. \e n1 and  \e n2refer to</span>
<a name="l00589"></a>00589 <span class="comment">the number of training examples landing in the \e if block and the \e else</span>
<a name="l00590"></a>00590 <span class="comment">block respectivly.</span>
<a name="l00591"></a>00591 <span class="comment"></span>
<a name="l00592"></a>00592 <span class="comment">Although not mentioned in the grammar, the indenting is kept very strict.</span>
<a name="l00593"></a>00593 <span class="comment"></span>
<a name="l00594"></a>00594 <span class="comment">This representation has been designed to be parsed very easily with simple</span>
<a name="l00595"></a>00595 <span class="comment">regular expressions, hence the use if "elsf" as opposed to "elif" or "elseif".</span>
<a name="l00596"></a>00596 <span class="comment"></span>
<a name="l00597"></a>00597 <span class="comment">@param node (sub)tree to serialize</span>
<a name="l00598"></a>00598 <span class="comment">@param o Stream to serialize to.</span>
<a name="l00599"></a>00599 <span class="comment">@param i Indent to print before each line of the serialized tree.</span>
<a name="l00600"></a>00600 <span class="comment">*/</span>
<a name="l00601"></a><a class="code" href="learn__fast__tree_8cc.html#787dd76ed463ffe6364edd7699ccbd5a">00601</a> <span class="keywordtype">void</span> <a class="code" href="learn__fast__tree_8cc.html#787dd76ed463ffe6364edd7699ccbd5a" title="This function traverses the tree and produces a textual representation of it.">print_tree</a>(<span class="keyword">const</span> <a class="code" href="structtree.html" title="This class represents a decision tree.">tree</a>* node, ostream&amp; o, <span class="keyword">const</span> <span class="keywordtype">string</span>&amp; i=<span class="stringliteral">""</span>)
<a name="l00602"></a>00602 {
<a name="l00603"></a>00603     <span class="keywordflow">if</span>(node-&gt;<a class="code" href="structtree.html#2b87abfe9d4b7855a69e7f6cd741ae0d" title="Class of this node (if its a leaf).">is_a_corner</a> == <a class="code" href="structtree.html#b5c56b6f06ca97e05a0279bc160b5ac067ff8625432546cee52c13791b5aa44a">tree::Corner</a>)
<a name="l00604"></a>00604         o &lt;&lt; i &lt;&lt; <span class="stringliteral">"corner"</span> &lt;&lt; endl;
<a name="l00605"></a>00605     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(node-&gt;<a class="code" href="structtree.html#2b87abfe9d4b7855a69e7f6cd741ae0d" title="Class of this node (if its a leaf).">is_a_corner</a> == <a class="code" href="structtree.html#b5c56b6f06ca97e05a0279bc160b5ac00572318008570e7add7191eabe4309f3">tree::NonCorner</a>)
<a name="l00606"></a>00606         o &lt;&lt; i &lt;&lt; <span class="stringliteral">"background"</span> &lt;&lt; endl;
<a name="l00607"></a>00607     <span class="keywordflow">else</span>
<a name="l00608"></a>00608     {
<a name="l00609"></a>00609         <span class="keywordtype">string</span> b = node-&gt;<a class="code" href="structtree.html#92cf3beb390f661b4c5486592013b140" title="Subtrees.">brighter</a>-&gt;stringify();
<a name="l00610"></a>00610         <span class="keywordtype">string</span> d = node-&gt;<a class="code" href="structtree.html#1f6f3125c2fab213da95dfdf530c13dc" title="Subtrees.">darker</a>-&gt;stringify();
<a name="l00611"></a>00611         <span class="keywordtype">string</span> s = node-&gt;<a class="code" href="structtree.html#19c5e5fecea332fce87f03fa7e5929f5" title="Subtrees.">similar</a>-&gt;stringify();
<a name="l00612"></a>00612 
<a name="l00613"></a>00613         <span class="keyword">const</span> <a class="code" href="structtree.html" title="This class represents a decision tree.">tree</a> * bt = node-&gt;<a class="code" href="structtree.html#92cf3beb390f661b4c5486592013b140" title="Subtrees.">brighter</a>.get();
<a name="l00614"></a>00614         <span class="keyword">const</span> <a class="code" href="structtree.html" title="This class represents a decision tree.">tree</a> * dt = node-&gt;<a class="code" href="structtree.html#1f6f3125c2fab213da95dfdf530c13dc" title="Subtrees.">darker</a>.get();
<a name="l00615"></a>00615         <span class="keyword">const</span> <a class="code" href="structtree.html" title="This class represents a decision tree.">tree</a> * st = node-&gt;<a class="code" href="structtree.html#19c5e5fecea332fce87f03fa7e5929f5" title="Subtrees.">similar</a>.get();
<a name="l00616"></a>00616         <span class="keywordtype">string</span> ii = i + <span class="stringliteral">" "</span>;
<a name="l00617"></a>00617 
<a name="l00618"></a>00618         <span class="keywordtype">int</span> f = node-&gt;<a class="code" href="structtree.html#1a36930bec5910f253a8961838481713" title="Feature (ie pixel) to test if this is a non-leaf.">feature_to_test</a>;
<a name="l00619"></a>00619     
<a name="l00620"></a>00620         <span class="keywordflow">if</span>(b == d &amp;&amp; d == s) <span class="comment">//All the same</span>
<a name="l00621"></a>00621         {
<a name="l00622"></a>00622             <span class="comment">//o &lt;&lt; i &lt;&lt; "if " &lt;&lt; f &lt;&lt; " is whatever\n";</span>
<a name="l00623"></a>00623             <a class="code" href="learn__fast__tree_8cc.html#787dd76ed463ffe6364edd7699ccbd5a" title="This function traverses the tree and produces a textual representation of it.">print_tree</a>(st, o, i);
<a name="l00624"></a>00624         }
<a name="l00625"></a>00625         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(d == s)  <span class="comment">//Bright is different</span>
<a name="l00626"></a>00626         {
<a name="l00627"></a>00627             o &lt;&lt; i &lt;&lt; <span class="stringliteral">"if_brighter "</span> &lt;&lt; f &lt;&lt; <span class="stringliteral">" "</span> &lt;&lt; bt-&gt;<a class="code" href="structtree.html#ce82fc013bf129de16ea47ccaddc64d1" title="Number of datapoints passing through this node.">num_datapoints</a> &lt;&lt; <span class="stringliteral">" "</span> &lt;&lt; dt-&gt;<a class="code" href="structtree.html#ce82fc013bf129de16ea47ccaddc64d1" title="Number of datapoints passing through this node.">num_datapoints</a>+st-&gt;<a class="code" href="structtree.html#ce82fc013bf129de16ea47ccaddc64d1" title="Number of datapoints passing through this node.">num_datapoints</a> &lt;&lt; endl;
<a name="l00628"></a>00628                 <a class="code" href="learn__fast__tree_8cc.html#787dd76ed463ffe6364edd7699ccbd5a" title="This function traverses the tree and produces a textual representation of it.">print_tree</a>(bt, o, ii);
<a name="l00629"></a>00629             o &lt;&lt; i &lt;&lt; <span class="stringliteral">"else"</span> &lt;&lt; endl;
<a name="l00630"></a>00630                 <a class="code" href="learn__fast__tree_8cc.html#787dd76ed463ffe6364edd7699ccbd5a" title="This function traverses the tree and produces a textual representation of it.">print_tree</a>(st, o, ii);
<a name="l00631"></a>00631             o &lt;&lt; i &lt;&lt; <span class="stringliteral">"end"</span> &lt;&lt; endl;
<a name="l00632"></a>00632 
<a name="l00633"></a>00633         }
<a name="l00634"></a>00634         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(b == s) <span class="comment">//Dark is different</span>
<a name="l00635"></a>00635         {   
<a name="l00636"></a>00636             o &lt;&lt; i &lt;&lt; <span class="stringliteral">"if_darker "</span> &lt;&lt; f &lt;&lt; <span class="stringliteral">" "</span> &lt;&lt; dt-&gt;<a class="code" href="structtree.html#ce82fc013bf129de16ea47ccaddc64d1" title="Number of datapoints passing through this node.">num_datapoints</a> &lt;&lt; <span class="stringliteral">" "</span> &lt;&lt; bt-&gt;<a class="code" href="structtree.html#ce82fc013bf129de16ea47ccaddc64d1" title="Number of datapoints passing through this node.">num_datapoints</a> + st-&gt;<a class="code" href="structtree.html#ce82fc013bf129de16ea47ccaddc64d1" title="Number of datapoints passing through this node.">num_datapoints</a> &lt;&lt; endl;
<a name="l00637"></a>00637                 <a class="code" href="learn__fast__tree_8cc.html#787dd76ed463ffe6364edd7699ccbd5a" title="This function traverses the tree and produces a textual representation of it.">print_tree</a>(dt, o, ii);
<a name="l00638"></a>00638             o &lt;&lt; i &lt;&lt; <span class="stringliteral">"else"</span> &lt;&lt; endl;
<a name="l00639"></a>00639                 <a class="code" href="learn__fast__tree_8cc.html#787dd76ed463ffe6364edd7699ccbd5a" title="This function traverses the tree and produces a textual representation of it.">print_tree</a>(st, o, ii);
<a name="l00640"></a>00640             o &lt;&lt; i &lt;&lt; <span class="stringliteral">"end"</span> &lt;&lt; endl;
<a name="l00641"></a>00641         }
<a name="l00642"></a>00642         <span class="keywordflow">else</span> <span class="keywordflow">if</span>(b == d) <span class="comment">//Similar is different</span>
<a name="l00643"></a>00643         {
<a name="l00644"></a>00644             o &lt;&lt; i &lt;&lt; <span class="stringliteral">"if_either "</span> &lt;&lt; f &lt;&lt; <span class="stringliteral">" "</span> &lt;&lt;  bt-&gt;<a class="code" href="structtree.html#ce82fc013bf129de16ea47ccaddc64d1" title="Number of datapoints passing through this node.">num_datapoints</a> + dt-&gt;<a class="code" href="structtree.html#ce82fc013bf129de16ea47ccaddc64d1" title="Number of datapoints passing through this node.">num_datapoints</a>  &lt;&lt; <span class="stringliteral">" "</span> &lt;&lt; st-&gt;<a class="code" href="structtree.html#ce82fc013bf129de16ea47ccaddc64d1" title="Number of datapoints passing through this node.">num_datapoints</a> &lt;&lt; endl;
<a name="l00645"></a>00645                 <a class="code" href="learn__fast__tree_8cc.html#787dd76ed463ffe6364edd7699ccbd5a" title="This function traverses the tree and produces a textual representation of it.">print_tree</a>(bt, o, ii);
<a name="l00646"></a>00646             o &lt;&lt; i &lt;&lt; <span class="stringliteral">"else"</span> &lt;&lt; endl;
<a name="l00647"></a>00647                 <a class="code" href="learn__fast__tree_8cc.html#787dd76ed463ffe6364edd7699ccbd5a" title="This function traverses the tree and produces a textual representation of it.">print_tree</a>(st, o, ii);
<a name="l00648"></a>00648             o &lt;&lt; i &lt;&lt; <span class="stringliteral">"end"</span> &lt;&lt; endl;
<a name="l00649"></a>00649         }
<a name="l00650"></a>00650         <span class="keywordflow">else</span> <span class="comment">//All different</span>
<a name="l00651"></a>00651         {
<a name="l00652"></a>00652             o &lt;&lt; i &lt;&lt; <span class="stringliteral">"if_brighter "</span> &lt;&lt; f &lt;&lt; <span class="stringliteral">" "</span>  &lt;&lt;  bt-&gt;<a class="code" href="structtree.html#ce82fc013bf129de16ea47ccaddc64d1" title="Number of datapoints passing through this node.">num_datapoints</a> &lt;&lt; <span class="stringliteral">" "</span> &lt;&lt; dt-&gt;<a class="code" href="structtree.html#ce82fc013bf129de16ea47ccaddc64d1" title="Number of datapoints passing through this node.">num_datapoints</a>  &lt;&lt; <span class="stringliteral">" "</span> &lt;&lt; st-&gt;<a class="code" href="structtree.html#ce82fc013bf129de16ea47ccaddc64d1" title="Number of datapoints passing through this node.">num_datapoints</a> &lt;&lt; endl;
<a name="l00653"></a>00653                 <a class="code" href="learn__fast__tree_8cc.html#787dd76ed463ffe6364edd7699ccbd5a" title="This function traverses the tree and produces a textual representation of it.">print_tree</a>(bt, o, ii);
<a name="l00654"></a>00654             o &lt;&lt; i &lt;&lt; <span class="stringliteral">"elsf_darker "</span> &lt;&lt; f &lt;&lt; endl;
<a name="l00655"></a>00655                 <a class="code" href="learn__fast__tree_8cc.html#787dd76ed463ffe6364edd7699ccbd5a" title="This function traverses the tree and produces a textual representation of it.">print_tree</a>(dt, o, ii);
<a name="l00656"></a>00656             o &lt;&lt; i &lt;&lt; <span class="stringliteral">"else"</span> &lt;&lt; endl;
<a name="l00657"></a>00657                 <a class="code" href="learn__fast__tree_8cc.html#787dd76ed463ffe6364edd7699ccbd5a" title="This function traverses the tree and produces a textual representation of it.">print_tree</a>(st, o, ii);
<a name="l00658"></a>00658             o &lt;&lt; i &lt;&lt; <span class="stringliteral">"end"</span> &lt;&lt; endl;
<a name="l00659"></a>00659         }
<a name="l00660"></a>00660     }
<a name="l00661"></a>00661 }
<a name="l00662"></a>00662 <span class="comment"></span>
<a name="l00663"></a>00663 <span class="comment">///This function loads data and builds a tree. It is templated because datapoint</span>
<a name="l00664"></a>00664 <span class="comment">///is templated, for reasons of memory efficiency.</span>
<a name="l00665"></a>00665 <span class="comment">///@param num_features Number of features used</span>
<a name="l00666"></a>00666 <span class="comment">///@param weights Weights on each feature. </span>
<a name="l00667"></a>00667 <span class="comment">///@return The learned tree, and number of datapoints.</span>
<a name="l00668"></a><a class="code" href="learn__fast__tree_8cc.html#7c577f5c2749b97093f09f57637f48fb">00668</a> <span class="comment"></span><span class="keyword">template</span>&lt;<span class="keywordtype">int</span> S&gt; V_tuple&lt;shared_ptr&lt;tree&gt;, uint64_t&gt;::type <a class="code" href="learn__fast__tree_8cc.html#7c577f5c2749b97093f09f57637f48fb" title="This function loads data and builds a tree.">load_and_build_tree</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> num_features, <span class="keyword">const</span> vector&lt;double&gt;&amp; weights)
<a name="l00669"></a>00669 {
<a name="l00670"></a>00670     assert(weights.size() == num_features);
<a name="l00671"></a>00671 
<a name="l00672"></a>00672     shared_ptr&lt;vector&lt;datapoint&lt;S&gt; &gt; &gt; l;
<a name="l00673"></a>00673     uint64_t num_datapoints;
<a name="l00674"></a>00674     
<a name="l00675"></a>00675     <span class="comment">//Load the data</span>
<a name="l00676"></a>00676     make_rtuple(l, num_datapoints) = load_features&lt;S&gt;(num_features);
<a name="l00677"></a>00677     
<a name="l00678"></a>00678     cerr &lt;&lt; <span class="stringliteral">"Loaded.\n"</span>;
<a name="l00679"></a>00679     
<a name="l00680"></a>00680     <span class="comment">//Build the tree</span>
<a name="l00681"></a>00681     shared_ptr&lt;tree&gt; <a class="code" href="structtree.html" title="This class represents a decision tree.">tree</a>;
<a name="l00682"></a>00682     tree  = build_tree&lt;S&gt;(*l, weights, num_features);
<a name="l00683"></a>00683 
<a name="l00684"></a>00684     <span class="keywordflow">return</span> make_vtuple(tree, num_datapoints);
<a name="l00685"></a>00685 }
<a name="l00686"></a>00686 
<a name="l00687"></a>00687 
<a name="l00688"></a>00688 <span class="comment"></span>
<a name="l00689"></a>00689 <span class="comment">///The main program</span>
<a name="l00690"></a>00690 <span class="comment">///@param argc Number of commandline arguments</span>
<a name="l00691"></a>00691 <span class="comment">///@param argv Commandline arguments</span>
<a name="l00692"></a><a class="code" href="learn__fast__tree_8cc.html#3c04138a5bfe5d72780bb7e82a18e627">00692</a> <span class="comment"></span><span class="keywordtype">int</span> <a class="code" href="extract__features_8cc.html#3c04138a5bfe5d72780bb7e82a18e627" title="Driving program.">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv)
<a name="l00693"></a>00693 {
<a name="l00694"></a>00694     <span class="comment">//Set up default arguments</span>
<a name="l00695"></a>00695     GUI.parseArguments(argc, argv);
<a name="l00696"></a>00696 
<a name="l00697"></a>00697     cin.sync_with_stdio(<span class="keyword">false</span>);
<a name="l00698"></a>00698     cout.sync_with_stdio(<span class="keyword">false</span>);
<a name="l00699"></a>00699 
<a name="l00700"></a>00700     <span class="comment"></span>
<a name="l00701"></a>00701 <span class="comment">    ///////////////////</span>
<a name="l00702"></a>00702 <span class="comment"></span>    <span class="comment">//read file</span>
<a name="l00703"></a>00703     
<a name="l00704"></a>00704     <span class="comment">//Read number of features</span>
<a name="l00705"></a>00705     <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> num_features;
<a name="l00706"></a>00706     cin &gt;&gt; num_features;
<a name="l00707"></a>00707     <span class="keywordflow">if</span>(!cin.good() || cin.eof())
<a name="l00708"></a>00708         <a class="code" href="group__gUtility.html#g9a3d9e758aa01b90e2067121300f17d2" title="Print an error message and the exit.">fatal</a>(6, <span class="stringliteral">"Error reading number of features."</span>);
<a name="l00709"></a>00709 
<a name="l00710"></a>00710     <span class="comment">//Read offset list</span>
<a name="l00711"></a>00711     vector&lt;ImageRef&gt; <a class="code" href="group__gTree.html#gba2611edc3d025abd67eb4d57c5e9672" title="Actual x,y offset of the offset numbers in the different available orientations.">offsets</a>(num_features);
<a name="l00712"></a>00712     <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i &lt; num_features; i++)
<a name="l00713"></a>00713         cin &gt;&gt; offsets[i];
<a name="l00714"></a>00714     <span class="keywordflow">if</span>(!cin.good() || cin.eof())
<a name="l00715"></a>00715         <a class="code" href="group__gUtility.html#g9a3d9e758aa01b90e2067121300f17d2" title="Print an error message and the exit.">fatal</a>(7, <span class="stringliteral">"Error reading offset list."</span>);
<a name="l00716"></a>00716 
<a name="l00717"></a>00717     <span class="comment">//Read weights for the various offsets</span>
<a name="l00718"></a>00718     vector&lt;double&gt; weights(offsets.size());
<a name="l00719"></a>00719     <span class="keywordflow">for</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i=0; i &lt; weights.size(); i++)
<a name="l00720"></a>00720         weights[i] = GV3::get&lt;double&gt;(sPrintf(<span class="stringliteral">"weights.%i"</span>, i), 1, 1);
<a name="l00721"></a>00721 
<a name="l00722"></a>00722 
<a name="l00723"></a>00723     shared_ptr&lt;tree&gt; <a class="code" href="structtree.html" title="This class represents a decision tree.">tree</a>;
<a name="l00724"></a>00724     uint64_t num_datapoints;
<a name="l00725"></a>00725 <span class="comment"></span>
<a name="l00726"></a>00726 <span class="comment">    ///Each feature takes up 2 bits. Since GCC doesn't pack any finer</span>
<a name="l00727"></a>00727 <span class="comment">    ///then 32 bits for hetrogenous structs, there is no point in having</span>
<a name="l00728"></a>00728 <span class="comment">    ///granularity finer than 16 features.</span>
<a name="l00729"></a>00729 <span class="comment"></span>    <span class="keywordflow">if</span>(num_features &lt;= 16)
<a name="l00730"></a>00730         make_rtuple(tree, num_datapoints) = load_and_build_tree&lt;16&gt;(num_features, weights);
<a name="l00731"></a>00731     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(num_features &lt;= 32)
<a name="l00732"></a>00732         make_rtuple(tree, num_datapoints) = load_and_build_tree&lt;32&gt;(num_features, weights);
<a name="l00733"></a>00733     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(num_features &lt;= 48)
<a name="l00734"></a>00734         make_rtuple(tree, num_datapoints) = load_and_build_tree&lt;48&gt;(num_features, weights);
<a name="l00735"></a>00735     <span class="keywordflow">else</span> <span class="keywordflow">if</span>(num_features &lt;= 64)
<a name="l00736"></a>00736         make_rtuple(tree, num_datapoints) = load_and_build_tree&lt;64&gt;(num_features, weights);
<a name="l00737"></a>00737     <span class="keywordflow">else</span>
<a name="l00738"></a>00738         <a class="code" href="group__gUtility.html#g9a3d9e758aa01b90e2067121300f17d2" title="Print an error message and the exit.">fatal</a>(8, <span class="stringliteral">"Too many feratures (%i). To learn from this, see %s, line %i."</span>, num_features, __FILE__, __LINE__);
<a name="l00739"></a>00739 
<a name="l00740"></a>00740     
<a name="l00741"></a>00741     cout &lt;&lt; num_features &lt;&lt; endl;
<a name="l00742"></a>00742     copy(offsets.begin(), offsets.end(), ostream_iterator&lt;ImageRef&gt;(cout, <span class="stringliteral">" "</span>));
<a name="l00743"></a>00743     cout &lt;&lt; endl;
<a name="l00744"></a>00744     <a class="code" href="learn__fast__tree_8cc.html#787dd76ed463ffe6364edd7699ccbd5a" title="This function traverses the tree and produces a textual representation of it.">print_tree</a>(tree.get(), cout);
<a name="l00745"></a>00745 }
</pre></div><hr size="1"><address style="text-align: right;"><small>Generated on Wed Nov 5 10:25:01 2008 for FAST-ER by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.3 </small></address>
</body>
</html>
